<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的账户 - 萤火AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-control {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
        }
        .btn-primary {
            padding: 0.5rem 1rem;
            background-color: #4f46e5;
            color: white;
            border-radius: 0.375rem;
            font-weight: 500;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .alert {
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }
        .alert-success {
            background-color: #d1fae5;
            color: #065f46;
        }
        .alert-danger {
            background-color: #fee2e2;
            color: #b91c1c;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- 导航栏 -->
    <nav class="bg-white border-b border-gray-200 py-3 px-4 flex items-center justify-between shadow-sm">
        <div class="flex items-center">
            <a href="/" class="flex items-center">
                <span class="font-bold text-2xl text-indigo-600 mr-1">萤火AI</span>
                <span class="text-gray-500 text-sm ml-1">Yinghuo.Ai</span>
            </a>
        </div>
        <div class="flex items-center space-x-6">
            <a href="/" class="text-gray-600 hover:text-gray-900 flex items-center">
                <i class="ri-home-line mr-1"></i>
                <span>首页</span>
            </a>
        </div>
    </nav>

    <div class="max-w-4xl mx-auto mt-8 px-4">
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h1 class="text-2xl font-bold mb-6">我的账户</h1>

            <div class="hidden" id="message-box"></div>

            <div class="flex border-b border-gray-200">
                <button class="px-4 py-2 border-b-2 border-indigo-500 text-indigo-600 tab-button" data-tab="profile">
                    基本信息
                </button>
                <button class="px-4 py-2 text-gray-500 hover:text-gray-700 tab-button" data-tab="password">
                    修改密码
                </button>
            </div>

            <!-- 基本信息表单 -->
            <div id="profile-tab" class="tab-content mt-6">
                <form id="profile-form">
                    <div class="form-group">
                        <label for="username" class="block text-sm font-medium text-gray-700 mb-1">用户名</label>
                        <input type="text" id="username" name="username" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="masked-phone" class="block text-sm font-medium text-gray-700 mb-1">手机号</label>
                        <input type="text" id="masked-phone" name="masked-phone" class="form-control" readonly>
                        <p class="text-xs text-gray-500 mt-1">手机号码不可修改</p>
                    </div>
                    <button type="submit" class="btn-primary">保存修改</button>
                </form>
            </div>

            <!-- 修改密码表单 -->
            <div id="password-tab" class="tab-content mt-6 hidden">
                <form id="password-form">
                    <div class="form-group">
                        <label for="current-password" class="block text-sm font-medium text-gray-700 mb-1">当前密码</label>
                        <input type="password" id="current-password" name="currentPassword" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="new-password" class="block text-sm font-medium text-gray-700 mb-1">新密码</label>
                        <input type="password" id="new-password" name="newPassword" class="form-control" required minlength="6">
                        <p class="text-xs text-gray-500 mt-1">密码长度至少6位</p>
                    </div>
                    <div class="form-group">
                        <label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-1">确认新密码</label>
                        <input type="password" id="confirm-password" name="confirmPassword" class="form-control" required minlength="6">
                    </div>
                    <button type="submit" class="btn-primary">更新密码</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentUser = null;
        const messageBox = document.getElementById('message-box');
        
        // 显示消息
        function showMessage(message, type = 'success') {
            messageBox.innerHTML = `<div class="alert ${type === 'success' ? 'alert-success' : 'alert-danger'}">${message}</div>`;
            messageBox.classList.remove('hidden');
            
            // 3秒后自动隐藏
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000);
        }
        
        // 检查用户是否已登录
        function checkAuth() {
            const authToken = localStorage.getItem('authToken');
            const userInfo = localStorage.getItem('user');
            
            if (!authToken || !userInfo) {
                // 用户未登录，跳转到登录页面
                window.location.href = '/login.html';
                return false;
            }
            
            try {
                currentUser = JSON.parse(userInfo);
                return true;
            } catch (e) {
                console.error('解析用户信息出错:', e);
                // 清除无效的存储
                localStorage.removeItem('authToken');
                localStorage.removeItem('user');
                window.location.href = '/login.html';
                return false;
            }
        }
        
        // 加载用户信息
        async function loadUserInfo() {
            try {
                const response = await fetch('/api/auth/user', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success && data.data) {
                        // 更新全局用户信息
                        currentUser = data.data;
                        
                        // 更新localStorage中的用户信息
                        localStorage.setItem('user', JSON.stringify({
                            id: currentUser.id,
                            username: currentUser.username,
                            phone: currentUser.phone || ''
                        }));
                        
                        // 填充表单
                        document.getElementById('username').value = currentUser.username || '';
                        
                        // 显示部分隐藏的手机号
                        if (currentUser.phone && currentUser.phone.length === 11) {
                            const maskedPhone = currentUser.phone.substring(0, 3) + '****' + currentUser.phone.substring(7);
                            document.getElementById('masked-phone').value = maskedPhone;
                        } else {
                            document.getElementById('masked-phone').value = '';
                        }
                    }
                } else {
                    const error = await response.json();
                    showMessage(error.message || '获取用户信息失败', 'error');
                }
            } catch (error) {
                console.error('加载用户信息出错:', error);
                showMessage('加载用户信息出错，请刷新页面重试', 'error');
            }
        }
        
        // 处理基本信息表单提交
        document.getElementById('profile-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            
            if (!username.trim()) {
                showMessage('用户名不能为空', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/auth/update-profile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ username })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showMessage('个人信息更新成功');
                    
                    // 更新本地存储的用户信息
                    const userInfo = JSON.parse(localStorage.getItem('user'));
                    userInfo.username = username;
                    localStorage.setItem('user', JSON.stringify(userInfo));
                    
                    // 刷新用户信息
                    await loadUserInfo();
                } else {
                    showMessage(data.message || '更新失败，请重试', 'error');
                }
            } catch (error) {
                console.error('更新个人信息出错:', error);
                showMessage('更新出错，请稍后重试', 'error');
            }
        });
        
        // 处理修改密码表单提交
        document.getElementById('password-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            if (newPassword !== confirmPassword) {
                showMessage('两次输入的新密码不一致', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/auth/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ 
                        currentPassword,
                        newPassword 
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showMessage('密码修改成功');
                    document.getElementById('password-form').reset();
                } else {
                    showMessage(data.message || '密码修改失败，请重试', 'error');
                }
            } catch (error) {
                console.error('修改密码出错:', error);
                showMessage('修改密码出错，请稍后重试', 'error');
            }
        });
        
        // 处理标签页切换
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', function() {
                // 移除所有按钮的激活状态
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('border-b-2', 'border-indigo-500', 'text-indigo-600');
                    btn.classList.add('text-gray-500', 'hover:text-gray-700');
                });
                
                // 添加当前按钮的激活状态
                this.classList.add('border-b-2', 'border-indigo-500', 'text-indigo-600');
                this.classList.remove('text-gray-500', 'hover:text-gray-700');
                
                // 隐藏所有内容
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.add('hidden');
                });
                
                // 显示选择的内容
                const tabId = this.getAttribute('data-tab');
                document.getElementById(`${tabId}-tab`).classList.remove('hidden');
            });
        });
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', async function() {
            if (checkAuth()) {
                await loadUserInfo();
            }
        });
    </script>
</body>
</html>